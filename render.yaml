services:
  # Service 1: Backend (Python)
  - type: web
    name: guide2026-backend
    env: python
    rootDir: backend
    plan: free
    buildCommand: pip install -r requirements.txt
    startCommand: gunicorn -k uvicorn.workers.UvicornWorker server:app --bind 0.0.0.0:$PORT
    envVars:
      - key: PYTHON_VERSION
        value: "3.11.7"
      - key: MONGO_URI
        sync: false
      - key: DB_NAME
        value: "guide2026"
      - key: JWT_SECRET
        generateValue: true
      - key: CORS_ORIGINS
        value: "https://guide2026-frontend.onrender.com,http://localhost:3000"
      # Cloudinary Configuration (for persistent file storage)
      # Get these from https://cloudinary.com/console
      - key: CLOUDINARY_CLOUD_NAME
        sync: false
      - key: CLOUDINARY_API_KEY
        sync: false
      - key: CLOUDINARY_API_SECRET
        sync: false
      # Email Configuration (Resend HTTP API - SMTP is disabled)
      - key: RESEND_API_KEY
        sync: false
      - key: RESEND_FROM_EMAIL
        value: "auth@interguide.app"
      # Note: SMTP configuration below is not used (Resend HTTP API is used instead)
      - key: SMTP_HOST
        value: "smtp.resend.com"
      - key: SMTP_PORT
        value: "587"
      - key: SMTP_USER
        sync: false
      - key: SMTP_PASSWORD
        sync: false
      - key: SMTP_FROM_EMAIL
        value: "auth@interguide.app"
      - key: SMTP_FROM_NAME
        value: "Guide2026"
      - key: FRONTEND_URL
        value: "https://www.interguide.app"
      # Custom domain (update if using custom domain)
      # - key: FRONTEND_URL
      #   value: "https://www.interguide.app"

  # Service 2: Frontend (Static Site)
  - type: web
    name: guide2026-frontend
    runtime: static
    rootDir: frontend
    buildCommand: "npm ci --legacy-peer-deps && npm run build"
    staticPublishPath: build
    routes:
      # SPA fallback: allow deep-links like /portal/<slug>
      - type: rewrite
        source: /*
        destination: /index.html
    envVars:
      - key: NODE_VERSION
        value: "18.20.4"
      - key: CI
        value: "false"
      - key: REACT_APP_API_URL
        value: "https://api.interguide.app"